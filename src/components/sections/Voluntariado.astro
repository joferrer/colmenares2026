---
import { Image } from "astro:assets";
import logoAzul from "../../assets/logos/LOGO_BASE_ESTAFANIA-02.png";
import iconos from "../../assets/iconos/ICONOS_INDIVIDUALES-02.png";

const defaultMode = "voluntariado";

const modes = [
  {
    id: "voluntariado",
    label: "Voluntariado",
    badge: "V",
    title: "Voluntario/a",
    subtitle: "Quiero ser",
    formClass: "form-vol",
    iconClass: "form-icon-vol",
    inputClass: "field-input-vol",
    submitClass: "submit-vol",
    submitText: "Quiero ser voluntario/a",
  },
  {
    id: "donante",
    label: "Donante",
    badge: "D",
    title: "Donante",
    subtitle: "Quiero ser",
    formClass: "form-don",
    iconClass: "form-icon-don",
    inputClass: "field-input-don",
    submitClass: "submit-don",
    submitText: "Quiero aportar como donante",
  },
];

const fields = [
  {
    id: "nombre",
    label: "Nombre completo",
    type: "text",
    placeholder: "Ej: Maria Gomez",
  },
  {
    id: "cedula",
    label: "Cedula",
    type: "text",
    placeholder: "Ej: 1.234.567.890",
  },
  {
    id: "telefono",
    label: "Telefono",
    type: "tel",
    placeholder: "Ej: 3001234567",
  },
  {
    id: "correo",
    label: "Correo electronico",
    type: "email",
    placeholder: "Ej: correo@mail.com",
  },
  {
    id: "barrio",
    label: "Barrio y municipio",
    type: "text",
    placeholder: "Ej: Barrio Las Palmas, Cucuta",
  },
];
---

<section
  id="voluntariado"
  class="segmento vol-section container mx-auto max-w-7xl px-4 pt-12 pb-0 md:pt-18 md:pb-0"
>
  <div
    class="relative overflow-hidden rounded-3xl bg-white shadow-2xl ring-1 ring-[color:var(--azul)/18]"
  >
    <span class="blur-blob blob-1"></span>
    <span class="blur-blob blob-2"></span>

    <Image
      src={iconos}
      width={256}
      height={256}
      alt=""
      class="iconos-vol pointer-events-none absolute -top-10 -left-14 w-48 rotate-6 opacity-25 md:w-60 lg:w-72"
      loading="lazy"
    />
    <img
      src={logoAzul.src}
      alt="Logo Estefania Colmenares"
      class="logo-estefania pointer-events-none absolute -top-10 right-0 w-56 md:w-72 lg:w-80 opacity-20"
      loading="lazy"
    />

    <div class="relative px-6 py-10 md:px-12 md:py-16 lg:px-20">
      <div class="mb-10 space-y-6">
        <span class="pill">Participa</span>
        <h2 class="heading">Sumate como voluntario o donante</h2>

        <p class="lede">
          Llena tus datos y cambia el selector para elegir tu rol. Al enviar,
          nos pondremos en contacto para coordinar como puedes aportar.
        </p>

        <div class="mode-switch" data-mode-switch data-mode={defaultMode}>
          <span class="mode-pill" aria-hidden="true"></span>
          {
            modes.map((mode, index) => (
              <button
                type="button"
                class={`mode-btn ${index === 0 ? "is-active" : ""}`}
                data-mode-btn
                data-mode={mode.id}
                aria-pressed={index === 0 ? "true" : "false"}
              >
                <span class="badge">{mode.badge}</span>
                <span class="mode-text">{mode.label}</span>
              </button>
            ))
          }
        </div>
      </div>

      <div class="relative" data-forms-panel data-mode={defaultMode}>
        <div class="forms-wrapper">
          {
            modes.map((mode, index) => (
              <form
                class={`form-card ${mode.formClass} ${index === 0 ? "is-active" : ""}`}
                data-form={mode.id}
                aria-hidden={index === 0 ? "false" : "true"}
                hidden={index === 0 ? undefined : true}
              >
                <div class="form-header">
                  <span class={`form-icon ${mode.iconClass}`}>
                    {mode.badge}
                  </span>
                  <div>
                    <p class="form-subtitle">{mode.subtitle}</p>
                    <h3 class="form-title">{mode.title}</h3>
                  </div>
                </div>

                <div class="form-fields">
                  {fields.map((field) => (
                    <label class="field-label" for={`${field.id}-${mode.id}`}>
                      {field.label}
                      <input
                        id={`${field.id}-${mode.id}`}
                        name={field.id}
                        type={field.type}
                        placeholder={field.placeholder}
                        class={`field-input ${mode.inputClass}`}
                        required
                        aria-required="true"
                      />
                    </label>
                  ))}
                </div>

                <button type="submit" class={`submit-btn ${mode.submitClass}`}>
                  <span class="submit-text">{mode.submitText}</span>
                  <span class="submit-loader" aria-hidden="true" />
                </button>
              </form>
            ))
          }
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .vol-section {
    --azul: var(--cd-azul, #1f6fb7);
    --amarillo: var(--cd-amarillo, #fec900);
    --oscuro: var(--cd-oscuro, #1f2d4a);
    --claro: #f3f6fb;
  }

  .blur-blob {
    position: absolute;
    border-radius: 999px;
    filter: blur(40px);
    opacity: 0.6;
  }

  .blob-1 {
    top: 2.5rem;
    left: -2.5rem;
    width: 8rem;
    height: 8rem;
    background: color-mix(in srgb, var(--azul) 70%, transparent);
  }

  .blob-2 {
    right: -3rem;
    bottom: -2.5rem;
    width: 10rem;
    height: 10rem;
    background: color-mix(in srgb, var(--amarillo) 75%, transparent);
  }

  .pill {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.95rem;
    border-radius: 999px;
    background: color-mix(in srgb, var(--azul) 12%, white);
    color: var(--oscuro);
    font-size: 0.75rem;
    font-weight: 800;
    letter-spacing: 0.18em;
    text-transform: uppercase;
  }

  .heading {
    font-weight: 900;
    color: var(--oscuro);
    line-height: 1.05;
    font-size: clamp(2.2rem, 4vw, 3.5rem);
  }

  .lede {
    max-width: 38rem;
    color: color-mix(in srgb, var(--oscuro) 75%, white);
    font-size: 1.05rem;
    line-height: 1.65;
  }

  .mode-switch {
    position: relative;
    display: inline-flex;
    gap: 0.35rem;
    padding: 0.4rem;
    border-radius: 999px;
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--azul) 14%, white),
      color-mix(in srgb, var(--amarillo) 12%, white)
    );
    border: 1px solid color-mix(in srgb, var(--azul) 40%, transparent);
    box-shadow: 0 14px 30px -18px rgb(0 0 0 / 0.45);
    isolation: isolate;
  }

  .mode-pill {
    position: absolute;
    inset: 0.4rem;
    width: calc(50% - 0.4rem);
    background: white;
    border-radius: 999px;
    box-shadow: 0 14px 24px -14px rgb(0 0 0 / 0.35);
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    z-index: 0;
  }

  [data-mode="donante"] .mode-pill {
    transform: translateX(100%);
    background: linear-gradient(
      135deg,
      var(--amarillo),
      color-mix(in srgb, var(--azul) 35%, white)
    );
  }

  .mode-btn {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 0.55rem;
    padding: 0.75rem 1.2rem;
    border-radius: 999px;
    font-weight: 800;
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: color-mix(in srgb, var(--oscuro) 65%, white);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: color 0.25s ease;
  }

  .mode-btn.is-active {
    color: var(--oscuro);
  }

  .mode-btn:focus-visible {
    outline: 2px solid var(--azul);
    outline-offset: 2px;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 1.75rem;
    width: 1.75rem;
    border-radius: 50%;
    background: color-mix(in srgb, var(--oscuro) 10%, white);
    color: var(--oscuro);
    font-weight: 800;
    font-size: 0.82rem;
  }

  .forms-wrapper {
    position: relative;
    display: grid;
    gap: 12px;
  }

  .form-card {
    display: grid;
    gap: 1.5rem;
    padding: 2rem;
    border-radius: 1.5rem;
    backdrop-filter: blur(10px);
    border: 1px solid color-mix(in srgb, var(--azul) 22%, white);
    box-shadow: 0 25px 50px -30px rgb(0 0 0 / 0.35);
    opacity: 0;
    transform: translateY(22px);
    pointer-events: none;
    transition:
      opacity 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
      transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .form-card.is-active {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .form-vol {
    background: color-mix(in srgb, var(--azul) 5%, white);
  }
  .form-don {
    background: color-mix(in srgb, var(--amarillo) 12%, white);
  }

  .form-header {
    display: flex;
    align-items: center;
    gap: 0.875rem;
  }

  .form-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 2.75rem;
    width: 2.75rem;
    border-radius: 50%;
    font-weight: 800;
    font-size: 1.125rem;
    color: white;
    box-shadow: 0 8px 18px rgb(0 0 0 / 0.15);
  }

  .form-icon-vol {
    background: var(--azul);
  }
  .form-icon-don {
    background: var(--amarillo);
    color: var(--oscuro);
  }

  .form-subtitle {
    font-size: 0.75rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: color-mix(in srgb, var(--oscuro) 70%, white);
  }

  .form-title {
    font-size: 1.5rem;
    font-weight: 900;
    color: var(--oscuro);
  }

  .form-fields {
    display: grid;
    gap: 1.2rem;
  }

  .field-label {
    display: flex;
    flex-direction: column;
    gap: 0.55rem;
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--oscuro);
  }

  .field-input {
    width: 100%;
    padding: 0.9rem 1rem;
    border-radius: 0.9rem;
    border: 1px solid color-mix(in srgb, var(--oscuro) 10%, white);
    background: white;
    color: var(--oscuro);
    font-size: 0.95rem;
    outline: none;
    transition: all 0.22s ease;
    box-shadow: 0 1px 2px rgb(0 0 0 / 0.06);
  }

  .field-input::placeholder {
    color: color-mix(in srgb, var(--oscuro) 55%, white);
  }

  .field-input-vol:focus {
    border-color: color-mix(in srgb, var(--azul) 65%, white);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--azul) 25%, transparent);
    transform: translateY(-1px);
  }

  .field-input-don:focus {
    border-color: color-mix(in srgb, var(--amarillo) 65%, white);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--amarillo) 25%, transparent);
    transform: translateY(-1px);
  }

  .field-input.input-error {
    border-color: rgb(239 68 68);
    box-shadow: 0 0 0 3px rgb(239 68 68 / 0.1);
  }

  .submit-btn {
    width: 100%;
    padding: 1rem 1.25rem;
    border-radius: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.65rem;
    font-weight: 800;
    font-size: 0.95rem;
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 8px 20px rgb(0 0 0 / 0.18);
    transition: all 0.25s ease;
  }

  .submit-btn.is-loading {
    cursor: wait;
  }
  .submit-btn:disabled {
    opacity: 0.85;
  }

  .submit-loader {
    width: 1rem;
    height: 1rem;
    border-radius: 999px;
    border: 2px solid color-mix(in srgb, currentColor 35%, transparent);
    border-top-color: currentColor;
    opacity: 0;
    transform: scale(0.6);
    transition: opacity 0.2s ease;
  }

  .submit-btn.is-loading .submit-loader {
    opacity: 1;
    transform: scale(1);
    animation: spin 0.8s linear infinite;
  }

  .submit-btn:hover {
    transform: translateY(-2px);
  }
  .submit-btn:active {
    transform: translateY(0);
  }

  .submit-vol {
    background: var(--oscuro);
  }
  .submit-vol:hover {
    background: var(--azul);
  }

  .submit-don {
    background: var(--oscuro);
  }
  .submit-don:hover {
    background: var(--amarillo);
    color: var(--oscuro);
  }

  /* ✅ Toast GLOBAL: como lo creamos en body, lo estilizamos global */
  :global(.toast-stack) {
    position: fixed;
    top: 1rem;
    right: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    width: min(360px, calc(100vw - 2rem));
    z-index: 2147483647;
    pointer-events: none;
  }

  :global(.toast) {
    --toast-accent: var(--azul);
    --toast-bg: white;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 1rem 1.25rem;
    border-radius: 1rem;
    background: var(--toast-bg);
    border: 1px solid color-mix(in srgb, var(--toast-accent) 35%, transparent);
    border-left: 6px solid var(--toast-accent);
    box-shadow: 0 20px 40px -15px rgb(0 0 0 / 0.25);
    animation: toast-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    pointer-events: auto;
  }

  :global(.toast.is-success) {
    --toast-accent: #16a34a;
    --toast-bg: #16a34a;
  }
  :global(.toast.is-error) {
    --toast-accent: #dc2626;
    --toast-bg: #dc2626;
  }

  :global(.toast.is-success .toast-title),
  :global(.toast.is-success .toast-message),
  :global(.toast.is-error .toast-title),
  :global(.toast.is-error .toast-message) {
    color: white;
  }

  :global(.toast.toast-out) {
    animation: toast-out 0.3s ease forwards;
  }

  :global(.toast-title) {
    font-weight: 800;
    font-size: 0.95rem;
    color: color-mix(in srgb, var(--toast-accent) 85%, black);
    letter-spacing: 0.01em;
  }

  :global(.toast-message) {
    font-size: 0.88rem;
    color: color-mix(in srgb, var(--oscuro) 70%, white);
  }

  @keyframes spin {
    from {
      transform: scale(1) rotate(0deg);
    }
    to {
      transform: scale(1) rotate(360deg);
    }
  }
  @keyframes toast-in {
    from {
      opacity: 0;
      transform: translateX(100%) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateX(0) scale(1);
    }
  }
  @keyframes toast-out {
    to {
      opacity: 0;
      transform: translateX(100%) scale(0.95);
    }
  }

  @media (max-width: 768px) {
    .mode-switch {
      width: 100%;
      justify-content: space-between;
    }

    .mode-btn {
      flex: 1;
      justify-content: center;
      padding: 0.65rem 1rem;
      font-size: 0.78rem;
    }

    .badge {
      height: 1.5rem;
      width: 1.5rem;
      font-size: 0.78rem;
    }

    :global(.toast-stack) {
      top: 0.75rem;
      right: 0.75rem;
    }

    .logo-estefania {
      display: none;
    }

    .iconos-vol {
      left: auto;
      right: 0;
    }
  }

  @media (min-width: 768px) {
    .mode-btn {
      margin-right: 25px;
    }
  }

  @media (max-width: 520px) {
    .mode-btn {
      padding: 0.6rem 0.75rem;
      gap: 0.35rem;
      font-size: 0.75rem;
    }

    .mode-text {
      font-size: 0.78rem;
      white-space: nowrap;
    }

    .badge {
      display: none;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const panel = document.querySelector("[data-forms-panel]");
    const buttons = document.querySelectorAll("[data-mode-btn]");
    const switcher = document.querySelector("[data-mode-switch]");
    const forms = document.querySelectorAll("form[data-form]");

    if (!panel || !buttons.length) return;

    // ✅ Creamos/reusamos un toast stack GLOBAL en body (fuera de .segmento con transform)
    const getGlobalToastStack = () => {
      let stack = document.querySelector("#global-toast-stack");
      if (!stack) {
        stack = document.createElement("div");
        stack.id = "global-toast-stack";
        stack.className = "toast-stack";
        stack.setAttribute("role", "status");
        stack.setAttribute("aria-live", "polite");
        document.body.appendChild(stack);
      }
      return stack;
    };

    const toastStack = getGlobalToastStack();

    let audioContext = null;

    const playSuccessSound = () => {
      const AudioContextRef = window.AudioContext || window.webkitAudioContext;
      if (!AudioContextRef) return;

      if (!audioContext) audioContext = new AudioContextRef();
      if (audioContext.state === "suspended") audioContext.resume();

      const now = audioContext.currentTime;

      // Primera nota (Do alto)
      const oscillator1 = audioContext.createOscillator();
      const gain1 = audioContext.createGain();
      oscillator1.type = "sine";
      oscillator1.frequency.value = 523.25; // C5
      gain1.gain.value = 0.0001;
      oscillator1.connect(gain1);
      gain1.connect(audioContext.destination);
      gain1.gain.exponentialRampToValueAtTime(0.15, now + 0.02);
      gain1.gain.exponentialRampToValueAtTime(0.0001, now + 0.15);
      oscillator1.start(now);
      oscillator1.stop(now + 0.2);

      // Segunda nota (Mi - E5)
      const oscillator2 = audioContext.createOscillator();
      const gain2 = audioContext.createGain();
      oscillator2.type = "triangle";
      oscillator2.frequency.value = 659.25;
      gain2.gain.value = 0.0001;
      oscillator2.connect(gain2);
      gain2.connect(audioContext.destination);
      gain2.gain.exponentialRampToValueAtTime(0.12, now + 0.12);
      gain2.gain.exponentialRampToValueAtTime(0.0001, now + 0.35);
      oscillator2.start(now + 0.1);
      oscillator2.stop(now + 0.4);
    };

    // ✅ 2s exactos, y se elimina al terminar la animación
    const showToast = (title, message, type = "info") => {
      const toast = document.createElement("div");
      toast.className = `toast${type ? ` is-${type}` : ""}`;
      toast.innerHTML = `
        <div class="toast-title">${title}</div>
        <div class="toast-message">${message}</div>
      `;

      toastStack.appendChild(toast);

      const VISIBLE_MS = 2500;
      const OUT_MS = 300;

      const removeToast = () => {
        if (!toast.isConnected) return;
        toast.remove();
      };

      setTimeout(() => {
        toast.classList.add("toast-out");
        toast.addEventListener("animationend", removeToast, { once: true });
        setTimeout(removeToast, OUT_MS + 50);
      }, VISIBLE_MS);
    };

    const setButtonLoading = (button, isLoading) => {
      if (!button) return;
      const textEl = button.querySelector(".submit-text");

      if (isLoading) {
        button.classList.add("is-loading");
        button.setAttribute("aria-busy", "true");
        button.disabled = true;
        if (textEl) {
          button.dataset.originalText = textEl.textContent || "";
          textEl.textContent = "Enviando...";
        }
      } else {
        button.classList.remove("is-loading");
        button.removeAttribute("aria-busy");
        button.disabled = false;
        if (textEl && button.dataset.originalText !== undefined) {
          textEl.textContent = button.dataset.originalText;
          delete button.dataset.originalText;
        }
      }
    };

    const submitForm = async (form) => {
      const endpoint = form.getAttribute("action");
      const payload = new FormData(form);

      if (endpoint) {
        const response = await fetch(endpoint, {
          method: "POST",
          body: payload,
          headers: { Accept: "application/json" },
        });
        return response.ok;
      }

      await new Promise((resolve) => setTimeout(resolve, 1200));
      return true;
    };

    const setMode = (mode) => {
      panel.setAttribute("data-mode", mode);
      if (switcher) switcher.setAttribute("data-mode", mode);

      forms.forEach((form) => {
        const isActive = form.dataset.form === mode;
        form.classList.toggle("is-active", isActive);
        form.toggleAttribute("hidden", !isActive);
        form.setAttribute("aria-hidden", isActive ? "false" : "true");
      });

      buttons.forEach((btn) => {
        const isActive = btn.dataset.mode === mode;
        btn.classList.toggle("is-active", isActive);
        btn.setAttribute("aria-pressed", isActive ? "true" : "false");
      });
    };

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        setMode(btn.dataset.mode || "voluntariado");
      });
    });

    forms.forEach((form) => {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const inputs = form.querySelectorAll("input");
        let hasErrors = false;

        inputs.forEach((input) => {
          if (!input.value.trim()) {
            input.classList.add("input-error");
            hasErrors = true;
          } else {
            input.classList.remove("input-error");
          }
        });

        if (hasErrors) {
          showToast(
            "Faltan datos",
            "Por favor completa todos los campos requeridos",
            "error"
          );
          return;
        }

        const submitButton = form.querySelector("button[type='submit']");
        setButtonLoading(submitButton, true);

        try {
          const ok = await submitForm(form);

          if (ok) {
            showToast(
              "Registro exitoso",
              "Gracias por sumarte. Te contactaremos pronto.",
              "success"
            );
            playSuccessSound();
            form.reset();
          } else {
            showToast(
              "Ocurrio un error",
              "Intenta de nuevo en unos minutos.",
              "error"
            );
          }
        } catch (error) {
          showToast(
            "Ocurrio un error",
            "Intenta de nuevo en unos minutos.",
            "error"
          );
        } finally {
          setButtonLoading(submitButton, false);
        }
      });

      form.querySelectorAll("input").forEach((input) => {
        input.addEventListener("input", () =>
          input.classList.remove("input-error")
        );
      });
    });

    setMode(panel.getAttribute("data-mode") || "voluntariado");
  });
</script>
